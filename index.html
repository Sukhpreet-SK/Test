<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>SmartProdLine365 ‚Äì Ingredient System (Multi-Entity)</title>
<style>
:root{
  --green:#00b33c;--green-dark:#007a33;--red:#cc0000;--amber:#f59e0b;
  --bg1:#003300;--bg2:#004d00;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff;min-height:100vh}
.container{max-width:1400px;margin:0 auto;padding:16px}
.input,select{width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;font-size:15px;background:#fff}
.btn{border:0;border-radius:8px;padding:8px 14px;font-weight:700;cursor:pointer}
.btn-primary{background:var(--green);color:#fff}
.btn-success{background:var(--green-dark);color:#fff}
.btn-danger{background:var(--red);color:#fff}
.btn-warning{background:var(--amber);color:#fff}
.tabs{display:flex;gap:8px;margin:14px 0;flex-wrap:wrap}
.tab{flex:1 1 150px;text-align:center;background:#1f2937;color:#cbd5e1;padding:10px;border-radius:10px 10px 0 0;cursor:pointer;font-weight:700}
.tab.active{background:var(--green);color:#fff}
.panel{display:none;background:#f9fafb;color:#111;border-radius:0 0 12px 12px;padding:18px}
.panel.active{display:block}
.request-card{background:#fff;border-left:5px solid var(--green);border-radius:10px;padding:14px;margin:10px 0;color:#111}
.request-card.completed{opacity:.85;border-left-color:#0a7a3a}
.priority-badge{padding:4px 10px;border-radius:20px;color:#fff;font-weight:800;font-size:12px}
.priority-high{background:#e11d48}.priority-medium{background:#f59e0b}.priority-low{background:#10b981}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin:10px 0 18px}
.kpi{color:#fff;border-radius:14px;padding:20px;box-shadow:0 16px 40px rgba(0,0,0,.18)}
.kpi h3{margin-bottom:8px;font-size:13px;opacity:.95}
.kpi .val{font-size:34px;font-weight:900}
.kpi-purple{background:linear-gradient(135deg,#6366f1,#7c3aed)}
.kpi-green{background:linear-gradient(135deg,#10b981,#04a777)}
.kpi-orange{background:linear-gradient(135deg,#f59e0b,#f97316)}
.kpi-red{background:linear-gradient(135deg,#ef4444,#f43f5e)}
.kpi-gray{background:linear-gradient(135deg,#6b7280,#374151)}
.board{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-top:16px}
.board-col{background:#fff;border-radius:12px;padding:12px}
.usercard{border-radius:10px;padding:10px;margin:8px 0;color:#fff;font-weight:700;text-align:center}
.user-av{background:#16a34a}.user-lu{background:#facc15;color:#111}.user-br{background:#9ca3af}.user-off{background:#ef4444}
.alert{background:#d1fae5;color:#065f46;border-left:4px solid #10b981;border-radius:8px;padding:10px;margin-top:10px}
.empty{color:#6b7280;text-align:center;padding:26px}
.table{width:100%;background:#fff;color:#111;border-radius:10px;border-collapse:separate;border-spacing:0;overflow:hidden}
.table th,.table td{padding:10px;border-bottom:1px solid #e5e7eb}
.table th{background:#f3f4f6;text-align:left}
.topbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.tr-auto-off{background:#fee2e2;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login" style="max-width:420px;margin:10vh auto;background:#fff;color:#111;padding:22px;border-radius:14px;box-shadow:0 10px 36px rgba(0,0,0,.25)">
  <h2>üîê SmartProdLine365 Login</h2>
  <label>Entity / Company</label>
  <select id="loginEntity" class="input">
    <option value="TFNW">TFNW</option>
    <option value="TFSW">TFSW</option>
    <option value="TFTX">TFTX</option>
    <option value="TFPI">TFPI</option>
    <option value="TFTN">TFTN</option>
    <option value="TFIL">TFIL</option>
    <option value="TFNE">TFNE</option>
    <option value="TFNJ">TFNJ</option>
  </select>
  <label>Username</label><input id="loginUser" class="input" autocomplete="username">
  <label>Password</label><input id="loginPass" class="input" type="password" autocomplete="current-password">
  <button id="loginBtn" class="btn btn-primary" style="margin-top:10px">Login</button>
  <div id="loginMsg" style="color:#b91c1c;margin-top:10px"></div>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <div class="container">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div>
        <h1>SmartProdLine365 ‚Äì Ingredient System</h1>
        <div id="welcome" style="opacity:.85"></div>
      </div>
      <div class="topbar">
        <select id="availabilitySelect" class="input" style="width:auto;min-width:160px;display:none">
          <option>Available</option><option>Lunch</option><option>Break</option><option>Offline</option>
        </select>
        <button class="btn btn-success" onclick="softRefresh()">üîÑ Soft Refresh</button>
        <button class="btn btn-danger" onclick="logout()">Logout</button>
      </div>
    </div>

    <div id="tabs" class="tabs"></div>

    <!-- Request -->
    <div id="panel-request" class="panel">
      <h2>üìù Create Request</h2>
      <form id="reqForm" onsubmit="submitRequest(event)">
        <label>FG Item</label><input id="fgItemId" class="input" required>
        <label>Ingredient</label><input id="ingredientItemId" class="input" required>
        <label>Quantity</label><input id="quantity" type="number" min="0.01" class="input" required>
        <label>UOM</label>
        <select id="uom" class="input"><option>Lbs</option><option>Eaches</option><option>Cases</option></select>
        <label>Line</label>
        <select id="line" class="input">
          <option>Line08</option><option>Line09</option><option>Line10</option><option>Line11</option><option>Line12</option>
          <option>Line13</option><option>Line14</option><option>Line15</option><option>Line16</option><option>Line17</option>
          <option>Line18</option><option>Line19</option><option>Line20</option><option>Line21</option><option>Line22</option>
          <option>Line23</option><option>Hot-Kitchen</option><option>Deli</option><option>Protien-Prep</option><option>Tables</option>
        </select>
        <label>Priority</label>
        <select id="priority" class="input"><option>High</option><option>Medium</option><option>Low</option></select>
        <label>Area Requested</label>
        <select id="area" class="input"><option>Deli</option><option>WIP</option><option>Packaging</option><option>Produce</option></select>
        <label>User</label><input id="userRequested" class="input" readonly>
        <button class="btn btn-primary" type="submit" style="margin-top:10px">Submit</button>
      </form>
      <div id="reqOK" class="alert" style="display:none">‚úÖ Request Saved</div>
    </div>

    <!-- Picking -->
    <div id="panel-picking" class="panel"><h2>üì¶ Picking Interface</h2><div id="pickList"></div></div>

    <!-- KPI -->
    <div id="panel-kpi" class="panel">
      <h2>üìä Performance Dashboard</h2>
      <div class="kpi-grid">
        <div class="kpi kpi-purple"><h3>Total Requests</h3><div class="val" id="kpiTotal">0</div></div>
        <div class="kpi kpi-green"><h3>Completed</h3><div class="val" id="kpiCompleted">0</div></div>
        <div class="kpi kpi-orange"><h3>Pending</h3><div class="val" id="kpiPending">0</div></div>
        <div class="kpi kpi-red"><h3>Avg Pick Time</h3><div class="val" id="kpiAvg">--</div></div>
        <div class="kpi kpi-gray"><h3>Deleted</h3><div class="val" id="kpiDeleted">0</div></div>
      </div>
      <div style="background:#fff;border-radius:12px;padding:14px;margin-top:10px">
        <h3 style="margin:4px 0;color:#111">Request History</h3>
        <input type="text" id="kpiSearch" class="input" placeholder="üîé Search history‚Ä¶">
        <div id="kpiHistory" style="margin-top:14px"></div>
      </div>
    </div>

    <!-- Admin -->
    <div id="panel-admin" class="panel">
      <h2>‚öôÔ∏è Admin</h2>
      <h3>Add User</h3>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px">
        <input id="newUser" class="input" placeholder="Username">
        <input id="newPass" class="input" placeholder="Password">
        <select id="newRole" class="input"><option>Requester</option><option>Picker</option><option>Viewer</option><option>Admin</option></select>
        <select id="newArea" class="input"><option>Deli</option><option>WIP</option><option>Packaging</option><option>Produce</option><option>All</option></select>
        <button class="btn btn-primary" onclick="addUser()">Add</button>
      </div>
      <h3 style="margin-top:16px">Users</h3><div id="adminUsers"></div>
      <h3 style="margin-top:20px">üë• Picker Availability Board</h3><div id="availabilityBoard" class="board"></div>
    </div>
  </div>
</div>

<script>
/* ---------- STORAGE KEY BY ENTITY ---------- */
function key(name){
  const entity = localStorage.getItem('currentEntity') || 'TFNW';
  return `SmartProdLine365_${entity}_${name}`;
}

/* ---------- LOGIN ---------- */
function ensureAdmin(entity){
  let users = JSON.parse(localStorage.getItem(`SmartProdLine365_${entity}_users`)) || [];
  if(!users.find(u=>u.username==='admin')){
    users.push({username:'admin',password:'admin123',role:'Admin',area:'All',entity,status:'Offline'});
    localStorage.setItem(`SmartProdLine365_${entity}_users`,JSON.stringify(users));
  }
}

function login(){
  const entity = document.getElementById('loginEntity').value;
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();
  const msg = document.getElementById('loginMsg'); msg.textContent='';

  ensureAdmin(entity);
  let users = JSON.parse(localStorage.getItem(`SmartProdLine365_${entity}_users`)) || [];
  const user = users.find(x=>x.username===u && x.password===p);
  if(!user){msg.textContent='‚ùå Invalid username or password';return;}

  user.status='Available'; user.lastLogin=new Date().toISOString();
  localStorage.setItem(`SmartProdLine365_${entity}_users`,JSON.stringify(users));
  localStorage.setItem('currentUser',JSON.stringify(user));
  localStorage.setItem('currentEntity',entity);
  boot();
}
document.getElementById('loginBtn').onclick=login;

function logout(){
  const me=JSON.parse(localStorage.getItem('currentUser')||'null');
  const entity=localStorage.getItem('currentEntity');
  if(me && entity){
    let users=JSON.parse(localStorage.getItem(`SmartProdLine365_${entity}_users`))||[];
    const u=users.find(x=>x.username===me.username);
    if(u){u.status='Offline';u.lastLogout=new Date().toISOString();}
    localStorage.setItem(`SmartProdLine365_${entity}_users`,JSON.stringify(users));
  }
  localStorage.removeItem('currentUser');
  localStorage.removeItem('currentEntity');
  document.getElementById('login').style.display='block';
  document.getElementById('app').style.display='none';
}

/* ---------- AUTO LOGOUT (2 MIN) ---------- */
let inactivityTimer;
const AUTO_LOGOUT_MS=2*60*1000;
function resetInactivityTimer(){
  clearTimeout(inactivityTimer);
  inactivityTimer=setTimeout(()=>{
    const me=JSON.parse(localStorage.getItem('currentUser')||'null');
    if(me){alert('‚è∞ Auto-logout after 2 min inactivity');logout();}
  },AUTO_LOGOUT_MS);
}
['mousemove','keydown','click','scroll','touchstart'].forEach(e=>window.addEventListener(e,resetInactivityTimer,false));

/* ---------- BOOT ---------- */
function boot(){
  const me=JSON.parse(localStorage.getItem('currentUser')); if(!me)return;
  document.getElementById('login').style.display='none';
  document.getElementById('app').style.display='block';
  document.getElementById('welcome').textContent=`${me.username} (${me.role}) ‚Äì ${me.area} ‚Äì Company: ${me.entity}`;
  resetInactivityTimer();
  buildTabs(me.role);
}

/* ---------- TABS ---------- */
function buildTabs(role){
  const t=[];
  if(role==='Admin')t.push(['admin','Admin']);
  if(['Admin','Requester'].includes(role))t.push(['request','Request']);
  if(['Picker'].includes(role))t.push(['picking','Picking']);
  if(['Admin','Viewer','Requester','Picker'].includes(role))t.push(['kpi','KPI']);
  document.getElementById('tabs').innerHTML=t.map(x=>`<div class="tab" id="tab-${x[0]}" onclick="showPanel('${x[0]}')">${x[1]}</div>`).join('');
  showPanel(t[0][0]);
}
function showPanel(id){
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  document.getElementById('panel-'+id).classList.add('active');
  if(id==='picking')renderPicking();
  if(id==='kpi')renderKPI();
  if(id==='admin'){renderAdmin();renderAvailability();}
}

/* ---------- REQUESTS ---------- */
function generateCode(){return'REQ-'+Date.now();}
function submitRequest(e){
  e.preventDefault();
  const me=JSON.parse(localStorage.getItem('currentUser'));
  let requests=JSON.parse(localStorage.getItem(key('requests')))||[];
  let r={uniqueCode:generateCode(),fgItemId:fgItemId.value.trim(),ingredientItemId:ingredientItemId.value.trim(),
         quantity:quantity.value,uom:uom.value,line:line.value,priority:priority.value,area:area.value,
         userRequested:me.username,entity:me.entity,requestedTime:new Date().toISOString(),status:'pending'};
  requests.push(r);
  localStorage.setItem(key('requests'),JSON.stringify(requests));
  reqForm.reset();document.getElementById('reqOK').style.display='block';
  setTimeout(()=>document.getElementById('reqOK').style.display='none',1500);
  renderPicking();renderKPI();
}

/* ---------- PICKING ---------- */
function renderPicking(){
  const me=JSON.parse(localStorage.getItem('currentUser'));
  let requests=JSON.parse(localStorage.getItem(key('requests')))||[];
  let list=requests;
  if(me.entity!=='All')list=list.filter(r=>r.entity===me.entity);
  if(!list.length){pickList.innerHTML=`<div class="empty">üì≠ No Requests</div>`;return;}
  pickList.innerHTML=list.map(r=>{
    const done=r.status==='completed';
    let actions='';
    if(done){actions=`‚úÖ Completed`;}
    else if(r.status==='pending'){actions=`<button class="btn btn-primary" onclick="startPick('${r.uniqueCode}')">Start</button>`;}
    else if(r.status==='inProgress'){actions=`<button class="btn btn-success" onclick="completePick('${r.uniqueCode}')">Complete</button>`;}
    const pr=`<span class="priority-badge priority-${r.priority.toLowerCase()}">${r.priority}</span>`;
    return `<div class="request-card ${done?'completed':''}">
      <b>${r.uniqueCode}</b> ${pr}<br>FG: ${r.fgItemId} ‚Äì ING: ${r.ingredientItemId}<br>
      Qty: ${r.quantity} ${r.uom} ‚Ä¢ Line: ${r.line}<br>Status: ${r.status}<br>${actions}</div>`;
  }).join('');
}
function startPick(code){let reqs=JSON.parse(localStorage.getItem(key('requests')))||[];
  const r=reqs.find(x=>x.uniqueCode===code);if(!r)return;
  r.status='inProgress';r.pickStartTime=new Date().toISOString();
  localStorage.setItem(key('requests'),JSON.stringify(reqs));renderPicking();renderKPI();}
function completePick(code){let reqs=JSON.parse(localStorage.getItem(key('requests')))||[];
  const r=reqs.find(x=>x.uniqueCode===code);if(!r)return;
  r.status='completed';r.completedTime=new Date().toISOString();
  if(r.pickStartTime){r.pickDuration=Math.round((new Date(r.completedTime)-new Date(r.pickStartTime))/60000);}
  localStorage.setItem(key('requests'),JSON.stringify(reqs));renderPicking();renderKPI();}

/* ---------- KPI ---------- */
function renderKPI(){
  const reqs=JSON.parse(localStorage.getItem(key('requests')))||[];
  const total=reqs.length;
  const completed=reqs.filter(r=>r.status==='completed').length;
  const pending=reqs.filter(r=>r.status==='pending').length;
  const avgList=reqs.filter(r=>r.pickDuration!=null);
  const avg=avgList.length?Math.round(avgList.reduce((a,b)=>a+b.pickDuration,0)/avgList.length):0;
  document.getElementById('kpiTotal').textContent=total;
  document.getElementById('kpiCompleted').textContent=completed;
  document.getElementById('kpiPending').textContent=pending;
  document.getElementById('kpiDeleted').textContent=0;
  document.getElementById('kpiAvg').textContent=avg?avg+' min':'--';
  const q=(document.getElementById('kpiSearch').value||'').toLowerCase();
  const filtered=reqs.filter(r=>(r.uniqueCode||'').toLowerCase().includes(q)||(r.fgItemId||'').toLowerCase().includes(q));
  document.getElementById('kpiHistory').innerHTML=filtered.map(r=>`<div class="request-card ${r.status==='completed'?'completed':''}">
    <b>${r.uniqueCode}</b> ‚Äì ${r.status}<br>FG: ${r.fgItemId} / ING: ${r.ingredientItemId}<br>
    Qty: ${r.quantity} ${r.uom} ‚Ä¢ Line: ${r.line} ‚Ä¢ Entity: ${r.entity}
  </div>`).join('')||'<div class="empty">No Records</div>';
}
document.getElementById('kpiSearch').addEventListener('input',renderKPI);

/* ---------- ADMIN ---------- */
function addUser(){
  const entity=localStorage.getItem('currentEntity');
  let users=JSON.parse(localStorage.getItem(`SmartProdLine365_${entity}_users`))||[];
  const u=newUser.value.trim(),p=newPass.value.trim(),r=newRole.value,a=newArea.value;
  if(!u||!p){alert('Username/password required');return;}
  if(users.find(x=>x.username===u)){alert('User already exists');return;}
  users.push({username:u,password:p,role:r,area:a,entity,status:'Offline'});
  localStorage.setItem(`SmartProdLine365_${entity}_users`,JSON.stringify(users));
  newUser.value='';newPass.value='';renderAdmin();renderAvailability();
}
function renderAdmin(){
  const entity=localStorage.getItem('currentEntity');
  let users=JSON.parse(localStorage.getItem(`SmartProdLine365_${entity}_users`))||[];
  adminUsers.innerHTML='<table class="table"><thead><tr><th>User</th><th>Role</th><th>Area</th><th>Status</th></tr></thead><tbody>'+
  users.map(u=>`<tr><td>${u.username}</td><td>${u.role}</td><td>${u.area}</td><td>${u.status}</td></tr>`).join('')+'</tbody></table>';
}
function renderAvailability(){
  const entity=localStorage.getItem('currentEntity');
  let users=JSON.parse(localStorage.getItem(`SmartProdLine365_${entity}_users`))||[];
  const areas=['Deli','WIP','Packaging','Produce'];
  availabilityBoard.innerHTML=areas.map(a=>{
    const us=users.filter(u=>u.area===a||u.area==='All');
    return `<div class='board-col'><h4>${a}</h4>${us.map(u=>{
      const c=u.status==='Available'?'user-av':u.status==='Lunch'?'user-lu':u.status==='Break'?'user-br':'user-off';
      return `<div class='usercard ${c}'>${u.username} (${u.status})</div>`;
    }).join('')||'<div class="empty">No users</div>'}</div>`;
  }).join('');
}

/* ---------- REFRESH ---------- */
function softRefresh(){renderKPI();renderPicking();renderAdmin();renderAvailability();resetInactivityTimer();}
setInterval(softRefresh,30000);

/* ---------- STARTUP ---------- */
window.onload=()=>{
  const me=JSON.parse(localStorage.getItem('currentUser')||'null');
  if(me)boot();
  resetInactivityTimer();
};
</script>
</body>
</html>
